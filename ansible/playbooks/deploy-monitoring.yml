- name: Deploy monitoring stack
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    - name: Apply Prometheus rules
      shell: kubectl apply -f infra/prometheus/prometheus-rule.yaml

    - name: Apply Prometheus config (if used as ConfigMap)
      shell: kubectl create configmap prometheus-config --from-file=infra/prometheus/prometheus.yaml -n monitoring --dry-run=client -o yaml | kubectl apply -f -
      ignore_errors: yes  # Solo si est√°s usando esta config como volumen

    - name: Apply monitoring services
      shell: kubectl apply -f k8s/monitoring/monitoring-services.yaml

    - name: Apply service monitors
      shell: kubectl apply -f k8s/monitoring/service-monitors

    - name: Deploy Alertmanager
      shell: kubectl apply -f infra/alertmanager/alertmanager.yaml

    - name: Deploy Telegram webhook
      shell: |
        kubectl apply -f k8s/telegram-webhook/deployment.yaml
        kubectl apply -f k8s/telegram-webhook/service.yaml
        kubectl apply -f k8s/telegram-webhook/secret.yaml

    - name: Deploy Flask app
      shell: |
        kubectl apply -f k8s/deployments/flask-app-deployment.yaml
        kubectl apply -f k8s/services/flask-app-service.yaml

    - name: Deploy Network Monitor
      shell: |
        kubectl apply -f k8s/deployments/network-monitor-deployment.yaml
        kubectl apply -f k8s/deployments/network-monitor-service.yaml
        kubectl apply -f k8s/deployments/network-monitor-servicemonitor.yaml
