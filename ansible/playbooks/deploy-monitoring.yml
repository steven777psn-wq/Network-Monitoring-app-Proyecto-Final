- name: Deploy monitoring stack
  hosts: localhost
  connection: local
  gather_facts: false

  tasks:
    # üõ°Ô∏è Prometheus RBAC
    - name: Apply Prometheus RBAC
      shell: kubectl apply --validate=false -f "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../../k8s/permisos-rbac/prometheus-role.yaml"
        - "{{ playbook_dir }}/../../k8s/permisos-rbac/prometheus-rolebinding.yaml"
      tags: prometheus_rbac

    # üìä Prometheus Config & Rules
    - name: Apply Prometheus rules
      shell: kubectl apply --validate=false -f "{{ playbook_dir }}/../../infra/prometheus/prometheus-rule.yaml"
      tags: prometheus_rules

    - name: Apply Prometheus config (ConfigMap)
      shell: |
        kubectl create configmap prometheus-config \
          --from-file="{{ playbook_dir }}/../../infra/prometheus/prometheus.yaml" \
          -n monitoring --dry-run=client -o yaml | kubectl apply -f -
      ignore_errors: yes
      tags: prometheus_config

    # üß© Monitoring Services
    - name: Apply monitoring services
      shell: kubectl apply --validate=false -f "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../../k8s/monitoring/monitoring-services.yaml"
        - "{{ playbook_dir }}/../../k8s/monitoring/service-monitors"
      tags: monitoring_services

    # üö® Alertmanager
    - name: Apply Alertmanager config
      shell: kubectl apply --validate=false -f "{{ playbook_dir }}/../../infra/alertmanager/alertmanager-config.yaml"
      tags: alertmanager

    # üì¨ Telegram Webhook
    - name: Deploy Telegram webhook
      shell: kubectl apply --validate=false -f "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../../k8s/telegram-webhook/deployment.yaml"
        - "{{ playbook_dir }}/../../k8s/telegram-webhook/service.yaml"
        - "{{ playbook_dir }}/../../k8s/telegram-webhook/secret.yaml"
      tags: telegram_webhook

    # üì° Network Monitor
    - name: Deploy Network Monitor
      shell: kubectl apply --validate=false -f "{{ item }}"
      loop:
        - "{{ playbook_dir }}/../../k8s/deployments/network-monitor-deployment.yaml"
        - "{{ playbook_dir }}/../../k8s/deployments/network-monitor-service.yaml"
        - "{{ playbook_dir }}/../../k8s/deployments/network-monitor-servicemonitor.yaml"
      tags: network_monitor

    # ‚úÖ Notificaci√≥n final
    - name: Notify deployment success
      shell: echo -e "\e[32m‚úÖ Monitoring stack deployed successfully\e[0m"
      tags: notify
